<!DOCTYPE html>
<html>
<head>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1em; }
    button { padding: 0.6em 1.2em; font-size: 1em; }
    #status { margin-top: 1em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Load Stock Quarterly History</h2>
  <button id="loadBtn">Import from FMP</button>
  <div id="status"></div>

  <script>
    const API_KEY = "59fxpu34TwH14sXxgyjU0PULL17ES3fL";

    let grist;
    let stocksTableId = null;
    let historyTableId = null;

    // Map Grist field names to FMP JSON fields
    const fieldMap = {
      Date: "date",
      PEG: "pegRatio",
      PE: "peRatio",
      EPS: "eps",
      ROE: "roe",
      ROA: "roa",
      DebtEquity: "debtToEquity",
      CurrentRatio: "currentRatio",
      QuickRatio: "quickRatio",
      PB: "pbRatio",
      DividendYield: "dividendYield",
      RevenuePerShare: "revenuePerShare",
      OperatingMargin: "operatingProfitMargin",
      GrossMargin: "grossProfitMargin",
      NetMargin: "netProfitMargin",
      FCFPerShare: "freeCashFlowPerShare",
      InterestCoverage: "interestCoverage",
      SalesGrowth5Y: "fiveYRevenueGrowthPerShare",
      SalesGrowth1Y: "revenueGrowth",
      EarningsGrowth1Y: "netIncomeGrowth",
      Price: "price",
      ForwardEpsGrowth5Y: "forwardEpsGrowth5Yr"  // Note the key difference here
    };

    // Receive grist API handle & config on message
    window.addEventListener("message", (event) => {
      if (event.source !== window.parent) return;
      grist = event.data;

      // Use widget options or fallback table names
      stocksTableId = grist.widgetOptions.stocksTable || "Stocks";
      historyTableId = grist.widgetOptions.historyTable || "StockQtlyHistory";
    });

    async function loadData() {
      if (!grist) {
        document.getElementById("status").innerText = "Widget not connected to Grist.";
        return;
      }

      document.getElementById("status").innerText = "Fetching tickers from Stocks table...";
      try {
        // Get all tickers from Stocks table
        const stocksData = await grist.docApi.getTable(stocksTableId).fetch();
        const tickers = stocksData.records.map(r => r.fields.Ticker).filter(Boolean);

        if (tickers.length === 0) {
          document.getElementById("status").innerText = "No tickers found in Stocks table.";
          return;
        }

        document.getElementById("status").innerText = `Found ${tickers.length} tickers. Fetching data...`;

        for (const ticker of tickers) {
          document.getElementById("status").innerText = `Fetching data for ${ticker}...`;

          // Fetch key metrics (last 40 quarters)
          const metricsUrl = `https://financialmodelingprep.com/api/v3/key-metrics/${ticker}?limit=40&apikey=${API_KEY}`;
          const metricsResp = await fetch(metricsUrl);
          if (!metricsResp.ok) throw new Error(`Failed to fetch key metrics for ${ticker}`);
          const metricsJson = await metricsResp.json();

          // Fetch price history (for Price mapping)
          const priceUrl = `https://financialmodelingprep.com/api/v3/historical-price-full/${ticker}?serietype=line&apikey=${API_KEY}`;
          const priceResp = await fetch(priceUrl);
          if (!priceResp.ok) throw new Error(`Failed to fetch price data for ${ticker}`);
          const priceJson = await priceResp.json();

          // Map date â†’ close price for quick lookup
          const priceMap = {};
          if (priceJson && priceJson.historical) {
            priceJson.historical.forEach(p => {
              priceMap[p.date] = p.close;
            });
          }

          // Build records, with Ticker as first field
          const records = metricsJson.map(entry => {
            const rec = { Ticker: ticker };
            for (const [gristCol, fmpField] of Object.entries(fieldMap)) {
              if (gristCol === "Price") {
                rec.Price = priceMap[entry.date] ?? null;
              } else {
                rec[gristCol] = entry[fmpField] ?? null;
              }
            }
            return { fields: rec };
          });

          // Bulk add records to StockQtlyHistory
          await grist.docApi.applyUserActions([
            ["BulkAddRecord", historyTableId, records]
          ]);
        }

        document.getElementById("status").innerText = "All data loaded successfully!";

      } catch (e) {
        document.getElementById("status").innerText = "Error loading data:\n" + e.message;
        console.error(e);
      }
    }

    document.getElementById("loadBtn").addEventListener("click", loadData);
  </script>
</body>
</html>
