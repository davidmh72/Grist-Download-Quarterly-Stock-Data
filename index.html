<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Grist Stock Metrics Downloader</title>
  <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
  <style>
    body { font-family: sans-serif; padding: 1.5em; }
    h2 { margin-top: 0; }
    #tickerDisplay, #sourceUrl { margin: 0.5em 0; font-size: 1em; }
    #sourceUrl a { color: #1a73e8; text-decoration: none; }
    #sourceUrl a:hover { text-decoration: underline; }
    #downloadBtn {
      padding: 0.6em 1.2em;
      font-size: 1em;
      background-color: #1a73e8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    #downloadBtn:hover { background-color: #1557b0; }
    #downloadBtn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    #status { margin-top: 1.5em; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h2>Download Stock Quarterly History</h2>
  <div id="tickerDisplay">No ticker selected.</div>
  <div id="sourceUrl">Source: <a href="https://financialmodelingprep.com/api/v3/key-metrics/" target="_blank">Financial Modeling Prep</a></div>
  <button id="downloadBtn" disabled>Download CSV</button>
  <div id="status">Initializing...</div>

  <script>
    const API_KEY = "59fxpu34TwH14sXxgyjU0PULL17ES3fL";
    const PROXY_URL = "https://cors-anywhere.herokuapp.com/";
    const BASE_URL = "https://financialmodelingprep.com/api/v3/key-metrics/";
    const fieldMap = {
      Date: "date",
      PEG: "pegRatio",
      PE: "peRatio",
      EPS: "eps",
      ROE: "roe",
      ROA: "roa",
      DebtEquity: "debtToEquity",
      CurrentRatio: "currentRatio",
      QuickRatio: "quickRatio",
      PB: "pbRatio",
      DividendYield: "dividendYield",
      RevenuePerShare: "revenuePerShare",
      OperatingMargin: "operatingProfitMargin",
      GrossMargin: "grossProfitMargin",
      NetMargin: "netProfitMargin",
      FCFPerShare: "freeCashFlowPerShare",
      InterestCoverage: "interestCoverage",
      SalesGrowth5Y: "fiveYRevenueGrowthPerShare",
      SalesGrowth1Y: "revenueGrowth",
      EarningsGrowth1Y: "netIncomeGrowth",
      Price: "price",
      ForwardEpsGrowth5Y: "forwardEpsGrowth5Yr"
    };

    let currentTicker = null;
    const status = document.getElementById("status");
    const tickerDisplay = document.getElementById("tickerDisplay");
    const downloadBtn = document.getElementById("downloadBtn");

    // Initialize Grist API
    grist.ready({
      requiredAccess: "read table",
      columns: [{ name: "Ticker", type: "Text" }]
    });

    // Capture Ticker from selected record
    grist.onRecord(record => {
      currentTicker = record.Ticker || null;
      tickerDisplay.innerText = currentTicker ? `Selected ticker: ${currentTicker}` : "No ticker selected.";
      downloadBtn.disabled = !currentTicker;
      status.innerText = currentTicker ? "Ready to download." : "Please select a ticker in Stocks table.";
    });

    // Download CSV on button click
    downloadBtn.addEventListener("click", async () => {
      if (!currentTicker) {
        status.innerText = "No ticker selected in Stocks table.";
        return;
      }

      status.innerText = `Fetching data for ${currentTicker}...`;

      try {
        const metricsUrl = `${PROXY_URL}${BASE_URL}${currentTicker}?limit=40&apikey=${API_KEY}`;
        const metricsResp = await fetch(metricsUrl);
        if (!metricsResp.ok) throw new Error(`Failed to fetch metrics: ${metricsResp.statusText}`);
        const metricsJson = await metricsResp.json();

        const priceUrl = `${PROXY_URL}https://financialmodelingprep.com/api/v3/historical-price-full/${currentTicker}?serietype=line&apikey=${API_KEY}`;
        const priceResp = await fetch(priceUrl);
        if (!priceResp.ok) throw new Error(`Failed to fetch price: ${priceResp.statusText}`);
        const priceJson = await priceResp.json();

        const priceMap = {};
        if (priceJson?.historical) {
          priceJson.historical.forEach(p => {
            priceMap[p.date] = p.close;
          });
        }

        // Create CSV
        const headers = ["Ticker", ...Object.keys(fieldMap)];
        const rows = metricsJson.map(entry => {
          const row = [currentTicker];
          for (const gristCol of Object.keys(fieldMap)) {
            const value = gristCol === "Price" ? priceMap[entry.date] ?? "" : entry[fieldMap[gristCol]] ?? "";
            row.push(`"${value}"`);
          }
          return row.join(",");
        });
        const csvContent = [headers.join(","), ...rows].join("\n");

        // Trigger download
        const blob = new Blob([csvContent], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = `${currentTicker}_StockQtlyHistory.csv`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        status.innerText = `CSV for ${currentTicker} downloaded. Open and copy/paste into StockQtlyHistory.`;
      } catch (e) {
        status.innerText = `Error: ${e.message}`;
        console.error(e);
      }
    });
  </script>
</body>
</html>
